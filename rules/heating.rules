import org.joda.time.*
import org.openhab.model.script.actions.*
import org.apache.commons.lang.StringUtils.*
import org.eclipse.xtext.xbase.lib.*


var boolean startHeating1
var boolean startHeating2

val Functions$Function1 filterTempValues = [ 
	boolean krneki|
	
	logDebug("heating", "Preverjam ali je potrebno filtrirati vrednosti")
	Temp.members.forEach[loopItem |
		logDebug("heating", "Preverjam za sobo - " + loopItem.toString)
		if (loopItem.groupNames.filter(group|group.equalsIgnoreCase("TempCal")).empty) {
			var Number temp = 18
			if (loopItem.state != NULL) temp = loopItem.state as Number
			if (temp <= 10 || temp >= 35) {
				logDebug("heating", "3.1 gledamo kakšna je vrednost odvoda zadnjih 15 min: " + (loopItem.deltaSince(now.minusMinutes(15)) as Number))
				logDebug("heating", "3.1 gledamo kakšna je vrednost evolution v zadnjih 15 min: " + (loopItem.evolutionRate(now.minusMinutes(16)) as Number))
				val historicState = loopItem.previousState
				loopItem.postUpdate(historicState.state)
				
				logDebug("heating", "Filtracija izvedena, nova vrednost - " + loopItem.toString)
			}
			loopItem.persist
		}
	]
	return true
]

val Functions$Function1 addMissingValues = [ 
	boolean krneki|
	
	logDebug("heating", "Preračunavam manjkajoče vrednosti")
//	TempDnevna.postUpdate(((TempKuhinja.state as DecimalType)*0.4) + ((TempKabinet.state as DecimalType)*0.6))
//	TempDnevna.persist
	logDebug("heating", "Dnevna - " + TempDnevna.toString)
	TempHodnikS.postUpdate(((TempKuhinja.state as DecimalType)*0.3) + ((TempKabinet.state as DecimalType)*0.4) + ((TempKopalnicaS.state as DecimalType)*0.3))
	TempHodnikS.persist
	logDebug("heating", "Hodnik spodaj - " + TempHodnikS.toString)
//	TempHodnikZ.postUpdate(((TempAljaz.state as DecimalType)*0.4) + ((TempJulija.state as DecimalType)*0.4) + ((TempKopalnicaZ.state as DecimalType)*0.2))
//	TempHodnikZ.persist
//	logDebug("heating", "Hodnik zgoraj - " + TempHodnikZ.toString)
	return true
]

val Functions$Function1 showFhsValues = [ 
	boolean krneki|

	logDebug("heating", "################Klic Log for FHS items################")
	Fhs.members.forEach[fhsItem|
		logDebug("heating", "Ventil je - " + fhsItem.toString)
	]
	logDebug("heating", "################Konec Log for FHS items################")		
	return true
]

	
rule "Set all necessary variables for heating"
when
	System started
then
	sendCommand(Heating, OFF)
	Log.members.forEach[item | 
		logDebug("heating", "Zapiram ventil " + item.toString)
		if (item == NULL) item.sendCommand(OFF)
	]
	Man.members.forEach[item | 
		logDebug("heating", "Zapiram ventil " + item.toString)
		if (item == NULL ) item.sendCommand(OFF)
	]
	Fhs.members.forEach[item | 
		logDebug("heating", "Zapiram ventil " + item.toString)
		if (item == NULL) item.sendCommand(OFF)
	]
	//setting up desired values for rooms
	Set.members.forEach[ item |
		if (item.state == NULL) item.postUpdate(20.0)
	]
	Dif.members.forEach[ item |
		if (item.state == NULL) item.postUpdate(0)
	]
	
	logDebug("heating", "1 Nastavljene začetne vrednosti!")
end

//checking to see if any of the rooms needs heating
rule "Checking if one of the rooms needs heating"
when
	Time cron "0 */5 * * * ?" or
	Item Set changed 
then
	logDebug("heating", "##################Preverjamo temperature#################")
	startHeating1 = false
	filterTempValues.apply(startHeating1)
	//addMissingValues.apply(startHeating1)
		Temp.members.forEach[ tempItem |
		logDebug("heating", "In the loop z - " + tempItem.toString)
//		if (Override.state == OFF) {
			logDebug("heating", "After if")
			val name = tempItem.name.substring(4)
			logDebug("heating", "Preverjam sobo - " + name)
			var setItem = Set.members.filter(setter | setter.name.containsIgnoreCase(name)).head
			if (setItem != null) {
				logDebug("heating", "Dobil setter - " + setItem.toString)
				val difItem = Dif.members.filter(setter | setter.name.containsIgnoreCase(name)).head
				logDebug("heating", "Dobil differ - " + difItem.toString)
				var Number currentTemp = 0
				if (tempItem.state != NULL) currentTemp = tempItem.state as Number 
				var Number mejnaTemp = 0
				if (setItem.state != NULL) mejnaTemp = setItem.state as Number
				logDebug("heating", "2 Preverjam ali je potrebno ogreti - " + setItem.toString)
				var logItem = Log.members.filter( doer | doer.name.containsIgnoreCase(name)).head
				logDebug("heating", "3 Našli smo ventil - " + logItem.toString)
				logDebug("heating", "3.1 gledamo kakšna je nastavljena vrednost za to sobo: " + mejnaTemp)
				if (Away.state == ON && LowElectricity.state == OFF) {
					mejnaTemp = mejnaTemp - 3
					logDebug("heating", "3.2 Ker ni nobenega doma in ni poceni elektrika je mejna temperatura zmanjšana za 3 - " + mejnaTemp)
				} else if (Away.state == ON && LowElectricity.state == ON) {
					mejnaTemp = mejnaTemp - 2
					logDebug("heating", "3.2 Ker ni nobenega doma in je poceni elektrika je mejna temperatura zmanjšana za 2 - " + mejnaTemp)
				} else if (now.getHourOfDay > 6 && now.getHourOfDay < 14 && now.getDayOfWeek < 6 && Holidays.state == OFF) {
					mejnaTemp = mejnaTemp - 0.2
					logDebug("heating", "3.2 Ker je zjutraj med tednom in nismo na dopustu, se mejna temperatura spusti za 0.2 stopinje - " + mejnaTemp)
				} else if (FhsHeater.state == ON && LowElectricity.state == ON) {
					mejnaTemp = mejnaTemp + 0.3
					logDebug("heating", "3.2 Ker se že ogreva in je nizka cena elektrike, se mejna temperatura dvigne za 0.3 stopinje - " + mejnaTemp)
				} else if (FhsHeater.state == ON) {
					mejnaTemp = mejnaTemp + 0.1
					logDebug("heating", "3.2 Ker se že ogreva, se mejna temperatura dvigne za 0.1 stopinje - " + mejnaTemp)
				} 
				val difTemp = currentTemp - mejnaTemp
				difItem.postUpdate(difTemp)
				difItem.persist
				if (Override.state == OFF) {
					logDebug("heating", "3.3 Temperatura sobe je - " + currentTemp)
					logDebug("heating", "3.4 Temperatura sobe bi morala biti - " + mejnaTemp)
					logDebug("heating", "3.5 If pa pride - " + (difTemp <= 0))
					if (difTemp <= 0) {
						startHeating1 = true
						logDebug("heating", "4.1 temperatura je prenizka, stikalo " + logItem.toString)
						if (logItem.state == OFF) {
							logItem.sendCommand(ON)
							logDebug("heating", "4.1.1 Izdan ukaz za ogrevanje sobe - " + name)
						}
					} else {
						logDebug("heating", "4.2 temperatura je previsoka, stikalo " + logItem.toString)
						if (logItem.state == ON) {
							logItem.sendCommand(OFF)
							logDebug("heating", "4.2.1 Izdan ukaz za konec ogrevanja sobe - " + name)
						}
//						logDebug("heating", "Preverjamo ali je temperatura toliko previsoka, da moramo spustiti žaluzije")
//					if ((difTemp > 3) && (Integer.parseInt((OutSolarRad.previousState.state as StringType).toString).intValue > 0)) {
//						val roomName = tempItem.name.substring(4, tempItem.name.length - 1)
//						logDebug("heating", "Temperatura je previsoka, spuščam žaluzije " + name)
//						BlindLog.members.forEach[roomBlind|
//							if (roomBlind.name.containsIgnoreCase(name)) {
//								logDebug("heating", "Našel stikalo " + roomBlind.toString)
//								if (roomBlind.name.containsIgnoreCase("Do")) {
//									val boolean lowAct = !roomBlind.groupNames.filter(group|group.equalsIgnoreCase("BlindRev")).empty
//									roomBlind.sendCommand(ON)
//									logDebug("heating", "Poslal ukaz za spust žaluzij " + roomBlind.toString)
//								} 
//							}
//						]
//					}
					}
				} else {
					logDebug("heating", "Ročni override zato ignoriral preračune!")
				}
			}
		]
//	showFhsValues.apply(startHeating1)
	if (startHeating1) {
		logDebug("heating", "5.1 Poslal ukaz za ogrevanje")
		sendCommand(LogOgrevanje, ON)
	} else if (!startHeating1 && FhsHeater.state == ON) {
		sendCommand(LogOgrevanje, OFF)
		logDebug("heating", "5.2 Poslal ukaz za konec ogrevanja")
	} if (Override.state == ON) {
		sendCommand(ManOgrevanje, ON);
	}
	logDebug("heating", "**********************Konec********************")
end

rule "Override is turned on"
when
	Item Override changed to ON
then
	logDebug("heating", "Ročno proženo upravljnanje z ogrevanjem - " + Override.toString)
	Man.members.forEach[manItem|
		logDebug("heating", "Nastavljamo ročno stikalo - " + manItem.toString)
		val name = manItem.name.substring(3)
		val boolean noVent = !manItem.groupNames.filter(group|group.equalsIgnoreCase("ManRev")).empty
		val valve = Fhs.members.filter(fhsTmpItem | fhsTmpItem.name.containsIgnoreCase(name)).head
		if (valve != null) {
			logDebug("heating", "Na vrednost ventila - " + valve.toString)
			if (valve.state == ON) { 
				if (!noVent) manItem.sendCommand(ON) else manItem.sendCommand(OFF) 
			} else {
				manItem.sendCommand(OFF)
			}
		} else {
			logWarn("heating", "Nisem našel ventila za ročno stikalo - " + manItem.toString)	
		}
		logDebug("heating", "In zaključimo - " + manItem.toString)
	]
	logDebug("heating", "Nastavimo logična stikala na OFF")
	Log.members.forEach[logItem|
		logItem.sendCommand(OFF)
	]
	logDebug("heating", "Konec Ročno proženo upravljnanje z ogrevanjem - " + Override.toString)
end

rule "Override is turned off"
when
	Item Override changed to OFF
then
	logDebug("heating", "Ročno izklopljeno upravljnanje z ogrevanjem - " + Override.toString)
	sendCommand(ManOgrevanje, OFF)
end


rule "heating of a room was requested by logic"
when
	Item LogOgrevanje received command or
	Item ManOgrevanje received command
then
	logDebug("heating", "*************************Pregled in vklop zahtevanih ventilov**************************")
	startHeating2 = false
	logDebug("heating", "Poglejmo ali je bilo ročno proženo ali ne - " + Override.toString)
	if (Override.state == OFF) {
		logDebug("heating", "Ogrevanje ni proženo ročno!")
		Log.members.forEach[ logItem |
			logDebug("heating", "Preverjamo za logično stikalo " + logItem.toString)
			val boolean noVent = !logItem.groupNames.filter(group|group.equalsIgnoreCase("LogRev")).empty
			val name = logItem.name.substring(3)
			val valve = Fhs.members.filter( fhsTmpItem | fhsTmpItem.name.containsIgnoreCase(name)).head
			if (valve != null) {
				logDebug("heating", "Našel ventil za logično stikalo " + valve.toString)
				if (logItem.state == ON) {
					startHeating2 = true
					if (!noVent) {
						if (valve.state == OFF) {
							valve.sendCommand(ON)
							logDebug("heating", "8.1 Našel normalen ventil za ročno odpret - " + valve.toString)
						}
					} else {
						if (valve.state == ON) {
							valve.sendCommand(OFF)
							logDebug("heating", "8.2 Našel NO ventil za ročno odpret - " + valve.toString)
						}
					}
				} else {
					if (!noVent) {
						if (valve.state == ON) {
							valve.sendCommand(OFF)
							logDebug("heating", "8.3 Našel normalen ventil za ročno zapret - " + valve.toString)
						}
					} else {
						if (valve.state == OFF && LogOgrevanje.state == ON) {
							valve.sendCommand(ON)
							logDebug("heating", "8.4 Našel NO ventil za ročno zapret - " + valve.toString)
						}
					}
				}
			} else {
				logWarn("heating", "Nisem našel ventila za ročno stikalo - " + name)
			}
		]
	} else {
		logDebug("heating", "Ogrevanje je proženo ročno!")
//		val manItem = Man.members.sortBy[lastUpdate].last
		Man.members.forEach[ manItem |
			logDebug("heating", "Preverjamo za ročno stikalo " + manItem.toString)
			val boolean noVent = !manItem.groupNames.filter(group|group.equalsIgnoreCase("ManRev")).empty
			logDebug("heating", "Ali je stikalo NO " + noVent)
			val name = manItem.name.substring(3)
			val valve = Fhs.members.filter( fhsTmpItem | fhsTmpItem.name.containsIgnoreCase(name)).head
			logDebug("heating", "Našel ventil za ročno stikalo " + valve.toString)
			if (valve != null) {
				val difItem = Dif.members.filter(setter | setter.name.containsIgnoreCase(name)).head
				logDebug("heating", "Dobil differ - " + difItem.toString)
				val Number difTemp = difItem.state as Number
				if (manItem.state == ON && difTemp < 0) {
					if (difTemp < 0) {
						logDebug("heating", "Ogrevam samo izbrano sobo, ker je ročni ukaz in nižja temperatura od nastavljene - " + difTemp)
						startHeating2 = true
						if (!noVent) {
							if (valve.state == OFF) {
								valve.sendCommand(ON)
								logDebug("heating", "8.1 Našel normalen ventil za ročno odpret - " + valve.toString)
							}
						} else {
							if (valve.state == ON) {
								valve.sendCommand(OFF)
								logDebug("heating", "8.2 Našel NO ventil za ročno odpret - " + valve.toString)
							}
						}
					} else {
						logDebug("heating", "Ne ogrevam izbrane sobe, ker je temperatura višja od nastavljene - " + difTemp)
					}
				} else if (Heating.state == ON || startHeating2){
					logDebug("heating", "Ne ogrevam izbrane sobe, ker je temperatura višja od nastavljene ali ni ročnega ukaza - " + difTemp)
					if (!noVent) {
						if (valve.state == ON) {
							valve.sendCommand(OFF)
							logDebug("heating", "8.3 Našel normalen ventil za ročno zapret - " + valve.toString)
						}
					} else {
						if (valve.state == OFF && ManOgrevanje.state == ON) {
							valve.sendCommand(ON)
							logDebug("heating", "8.4 Našel NO ventil za ročno zapret - " + valve.toString)
						}
					}
				}
			} else {
				logWarn("heating", "Nisem našel ventila za ročno stikalo - " + name)
			}
		]
	}
//	showFhsValues.apply(startHeating1)
	if (startHeating2) {
		logDebug("heating", "Vklopimo ogrevanje.")
		sendCommand(Heating, ON)
	} else {
		logDebug("heating", "Ker je ogrevanje izklopljeno ne preverjamo posameznih ventilov.")
		sendCommand(Heating, OFF)
	}
	logDebug("heating", "*************************Konec pregleda in vklopa zahtevanih ventilov**************************")
end

rule "Heating when ordered"
when
	Item Heating received command
then
	logDebug("heating", "Klic Heating when ordered - " + Heating.toString)
	if (Heating.state == ON) {
		sendCommand(FhsHeater, ON)
		logDebug("heating", "Ogrevanje se je vklopilo" + FhsHeater.toString)
	} else {
		sendCommand(FhsHeater, OFF)
		logDebug("heating", "Ogrevanje se je izklopilo, izklapljam še morebitne vklopljene ventile")
		//Turn off all the switches since we are not heating anymore
		Fhs.members.filter(item | item.state == ON).forEach[ tmpItem | 
			tmpItem.sendCommand(OFF)
			logDebug("heating", "Ugasnil ventil - " + tmpItem.toString)
		]
	}
//	showFhsValues.apply(true)
end